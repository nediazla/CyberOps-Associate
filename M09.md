# Módulo 9. Capa de Transporte (visión SOC)

La capa de transporte no es un concepto abstracto: es el punto donde se ve **cómo se comporta un atacante**.  
¿Escanea? ¿Establece conexiones? ¿Inicia DoS? ¿Exfiltra datos?  
Todo se revela aquí.

Veremos:

- TCP
    
- UDP
    
- Puertos y sesiones
    
- Anomalías
    
- Técnicas de escaneo
    
- Señales SOC
    
- MITRE ATT&CK relacionado
    

---

# 1. TCP (Transmission Control Protocol)

TCP es fiable, establece una sesión y controla el flujo de datos.

## 1.1 Handshake de 3 vías (3-way handshake)

1. SYN
    
2. SYN/ACK
    
3. ACK
    

Esto crea una conexión válida en la tabla del sistema (conntrack, state table).

### ¿Qué ve el SOC?

- Conexiones válidas → flujo normal
    
- Conexiones incompletas → escaneo o SYN flood
    
- RST repetidos → evasión o error sospechoso
    
- FIN tempranos → host intentando ocultar algo
    
- Flujos largos y constantes → posible beaconing C2
    

Zeek registra todo esto en **conn.log**.

---

## 1.2 Flags de TCP (clave para análisis SOC)

- **SYN**: iniciar conexión
    
- **ACK**: confirmar
    
- **FIN**: terminar
    
- **RST**: reiniciar
    
- **PSH**: empujar datos
    
- **URG**: dato urgente
    

### Señales de ataque:

- Muchos paquetes **SYN** → SYN flood
    
- SYN sin ACK repetidos → escaneo
    
- Paquetes **FIN**, **PSH**, **URG** juntos → Xmas scan
    
- Paquetes sin flags → Null scan
    
- RST masivos → evasión
    

Suricata produce firmas de detección específicas para scans.

---

# 2. UDP (User Datagram Protocol)

UDP es rápido, sin handshake y sin control de errores.  
Eso lo hace ideal para:

- DNS
    
- NTP
    
- VoIP
    
- Streaming
    
- Ataques de amplificación
    

## 2.1 ¿Qué ve un SOC?

- Paquetes a puertos UDP sin respuesta → scanning
    
- Tráfico excesivo hacia port 53 → DNS tunneling
    
- Tráfico inusual hacia port 123 → NTP amplification
    
- Consultas SNMP hacia 161 → reconocimiento
    
- Transferencia rápida y continua → exfiltración
    

Zeek registra tráfico UDP en **conn.log**, Suricata en **flow** o **dns** dependiendo del puerto.

---

# 3. Puertos y servicios

La relación **puerto → servicio** establece el comportamiento esperado.

Puertos típicos:

- 22 SSH
    
- 23 Telnet (inseguro)
    
- 25 SMTP
    
- 53 DNS
    
- 80 HTTP
    
- 110 POP3
    
- 143 IMAP
    
- 443 HTTPS
    
- 445 SMB
    
- 3389 RDP
    

### Señales de ataque:

- SSH abiertos al mundo con intentos masivos
    
- SMB donde no debería haber SMB
    
- RDP desde redes no autorizadas
    
- Puertos efímeros conectándose a uno fijo repetidamente (reconocimiento)
    
- Port knocking o tráfico en puertos “no estándar”
    

---

# 4. Técnicas de escaneo en la capa de transporte

### 4.1 SYN scan (más común)

Nmap lo usa por defecto:  
Envía SYN, espera SYN/ACK (puerto abierto) o RST (puerto cerrado).

### 4.2 Connect scan

Completa el handshake. Más ruidoso.

### 4.3 FIN scan

Envío de FIN sin conexión.  
Algunos sistemas responden RST si el puerto está abierto.

### 4.4 Xmas scan

Flags FIN+PSH+URG.  
Detectado fácilmente.

### 4.5 Null scan

Sin flags.

### 4.6 UDP scan

Envía UDP vacío y espera ICMP “Port Unreachable”.

### 4.7 Version detection

Enviar payloads para obtener banners.

### 4.8 OS fingerprinting

Inspección de respuestas para deducir el sistema operativo.

Estas técnicas dejan huellas en Zeek y Suricata.

---

# 5. ¿Qué detecta un analista SOC?

Este módulo es clave para detección:

### 5.1 Indicadores por TCP:

- Conexiones semi-abiertas
    
- Variación extraña en Sequence Numbers
    
- Ráfagas de SYN
    
- RST como evasión
    
- Handshakes incompletos
    

### 5.2 Indicadores por UDP:

- Flujos sin respuesta
    
- Tráfico repetitivo a un mismo puerto
    
- Amplificación (DNS, NTP, Memcached)
    
- Payloads inusuales
    

### 5.3 Indicadores mixtos:

- Beaconing C2 (ping regular en TCP/UDP)
    
- Reintentos constantes (brute force)
    
- Paquetes fragmentados
    
- Latencia anómala en conexiones
    

---

# 6. ¿Cómo se ve en herramientas profesionales?

### Zeek – conn.log

Campos:

- id.orig_h
    
- id.orig_p
    
- id.resp_h
    
- id.resp_p
    
- proto
    
- service
    
- duration
    
- conn_state
    
- history
    

`conn_state` es oro puro:

- S0 → SYN seen, no reply
    
- S1 → SYN/ACK reply but no ACK
    
- S2 → partial handshake
    
- SF → connection finished normally
    
- RSTO → RST from originator
    
- RSTR → RST from responder
    

Con estos códigos, un SOC detecta patrones de ataque.

### Suricata – EVE JSON

Alertas típicas:

- ET SCAN NMAP - Null Scan
    
- ET SCAN NMAP - Xmas
    
- ET INFO Outbound C2
    
- ET ATTACK Possible SYN Flood
    

### Wireshark

Filtros útiles:

```
tcp.flags.syn==1 && tcp.flags.ack==0
udp.port==53
tcp.flags.fin==1 && tcp.flags.psh==1 && tcp.flags.urg==1
icmp.type==3
```

---

# 7. MITRE ATT&CK asociado

Técnicas verificadas:

- **T1046 – Network Scanning**
    
- **T1040 – Network Sniffing**
    
- **T1498 – Network DoS**
    
- **T1090 – Proxying**
    
- **T1071 – C2 over TCP/UDP**
    
- **T1041 – Exfiltration Over C2 Channel**
    
- **T1020 – Exfiltration over network medium**
    

---

# 8. ¿Qué debe dominar el analista al finalizar este módulo?

- Interpretar un handshake TCP completo
    
- Identificar escaneos (SYN, FIN, Null, Xmas)
    
- Detectar anomalías en flags
    
- Analizar patrones sospechosos en UDP
    
- Reconocer amplificación DDoS
    
- Interpretar conn_state de Zeek
    
- Leer alertas de Suricata
    
- Diferenciar tráfico normal vs malicioso
    
- Detectar beaconing a nivel transporte