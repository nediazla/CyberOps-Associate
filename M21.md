# Módulo 21. Criptografía de Clave Pública – PKI (visión SOC)

El módulo cubre:

1. Criptografía simétrica vs asimétrica
    
2. Clave pública / clave privada
    
3. Certificados digitales
    
4. Cadena de confianza
    
5. CA, RA, CRL, OCSP
    
6. TLS/SSL
    
7. Uso legítimo vs malicioso
    
8. Señales SOC
    
9. MITRE asociado
    

Vamos paso a paso.

---

# 1. Criptografía simétrica vs asimétrica

### Simétrica

- Misma clave para cifrar y descifrar
    
- Rápida
    
- AES es el estándar moderno
    

### Asimétrica

- Par de claves: pública + privada
    
- Cifrado más lento
    
- RSA, ECC (Elliptic Curve Cryptography)
    

Se usa para:

- intercambio seguro de claves
    
- firma digital
    
- autenticación
    

---

# 2. Clave pública y clave privada

- **Clave pública**: se comparte
    
- **Clave privada**: NUNCA se comparte
    

Conceptos verificables:

- cifrar con clave pública → solo la privada lo descifra
    
- firmar con clave privada → la pública lo verifica
    

En SOC, esto es clave para validar autenticidad.

---

# 3. Certificados digitales (X.509)

Un certificado vincula:

- una clave pública
    
- una identidad (dominio, persona, entidad)
    
- una autoridad emisora
    

Campos importantes:

- Subject (identidad)
    
- Issuer (quién lo firmó)
    
- Expiration date
    
- Key Usage (firmar, cifrar, autenticar)
    
- SAN (Subject Alternative Name)
    
- Firma del CA
    

Verificable con:

`openssl x509 -in cert.pem -text -noout`

---

# 4. Cadena de confianza (Trust chain)

La PKI funciona en niveles:

1. **Root CA** (autoridad raíz)
    
2. **Intermediate CA**
    
3. **Issuing CA**
    
4. **Certificados finales (leaf)**
    

Cada uno firma al siguiente.

Si la cadena es válida → confianza.  
Si no → advertencia o bloqueo.

---

# 5. Infraestructura PKI

## 5.1 CA (Certificate Authority)

Emite certificados.

## 5.2 RA (Registration Authority)

Verifica identidades antes de que CA emita.

## 5.3 CRL (Certificate Revocation List)

Lista de certificados revocados.

## 5.4 OCSP (Online Certificate Status Protocol)

Consulta en tiempo real si un certificado está válido.

En SOC, OCSP es clave para identificar certificados comprometidos.

---

# 6. Certificados en redes empresariales

Usos típicos:

- TLS para HTTPS
    
- Autenticación de usuarios con certificados (EAP-TLS)
    
- Firma de software
    
- Firma de correo (S/MIME)
    
- VPN con certificados
    
- Firmas digitales internas
    

---

# 7. TLS/SSL (Transport Layer Security)

TLS asegura:

- Cifrado
    
- Integridad
    
- Autenticación
    

Fases del handshake:

1. ClientHello
    
2. ServerHello (incluye certificado)
    
3. Key Exchange
    
4. Encrypted traffic
    

En SOC, lo importante es:

- versión TLS
    
- algoritmo de cifrado
    
- certificado presentado
    
- SNI (Server Name Indication)
    

TLS versión seguras:

- TLS 1.2
    
- TLS 1.3
    

Versiones inseguras:

- SSL 2.0 / 3.0
    
- TLS 1.0 / 1.1
    

---

# 8. Cómo atacan los adversarios la PKI

## 8.1 Certificados auto-firmados

Señal de:

- malware
    
- C2
    
- MiTM
    
- túneles cifrados no autorizados
    

## 8.2 Certificados expirados

Indican:

- mala configuración
    
- posible abuso de endpoint
    

## 8.3 TLS tunneling

C2 oculto dentro de HTTPS.

Señales:

- Certificados raros
    
- SNI vacío
    
- Hostnames que no coinciden con el certificado
    
- Picos de tráfico HTTPS hacia un único dominio
    

## 8.4 Firma digital falsificada

Raro, pero posible mediante:

- claves robadas
    
- CA comprometida (caso DigiNotar, 2011)
    

## 8.5 Ataques MITM a TLS

Si un atacante controla gateway, puede:

- inyectar certificado falso
    
- hacer downgrade de cifrado
    
- redirigir tráfico
    

Señales SOC:

- Certificado cambia de un momento a otro
    
- TLS version downgrade
    
- Errores de validación
    

## 8.6 Certificados mal usados internamente

Ejemplo:  
Certificados wildcard muy amplios

- *.empresa.com  
    Abren posibilidades de abuso en servicios internos.
    

---

# 9. Detección SOC relacionada con PKI

### Señales del SIEM / Proxy:

- Certificados auto-firmados
    
- Certificados no coincidentes con dominio
    
- Conexiones TLS sin SNI
    
- TLS 1.0 o SSLv3
    
- Certificados con algoritmos débiles (SHA-1)
    
- Tráfico HTTPS elevado a un dominio recién creado
    

### Señales de TLS en Zeek:

- ssl.log
    
- información del certificado
    
- issuer, subject
    
- version
    
- cipher suite
    

### Suricata:

- “ET POLICY SSLv3 outbound”
    
- “ET INFO Self-signed certificate observed”
    

---

# 10. Buenas prácticas PKI (defensa)

- Usar TLS 1.2 y 1.3
    
- Deshabilitar SSLv3/TLS 1.0
    
- Rotar certificados
    
- Usar CA internas bien gestionadas
    
- Validar correctamente OCSP
    
- No usar certificados wildcard innecesarios
    
- Firmar binarios internos
    
- Asegurar claves privadas (HSM)
    
- Revisar expiry automatizado
    

---

# 11. MITRE ATT&CK asociado

- **T1552 – Unsecured Credentials**
    
- **T1587 – Develop Capabilities**
    
- **T1608 – Stage Capabilities**
    
- **T1071 – C2 over HTTPS**
    
- **T1040 – Credential Access via MITM**
    
- **T1550 – Use of Forged Certificates**
    

---

# 12. ¿Qué debe dominar un analista al terminar este módulo?

- Cómo funciona la criptografía de clave pública
    
- Cómo se valida una cadena de certificados
    
- Cómo detectar certificados maliciosos
    
- Cómo interpretar logs TLS (Zeek/Suricata/Proxy)
    
- Identificar C2 oculto en HTTPS
    
- Distinguir entre tráfico HTTPS legítimo vs sospechoso
    
- Detectar ataques MITM a TLS
    
- Ver manipulación de certificados
    
- Comprender cómo una PKI mal gestionada compromete toda la red