# Módulo 5. Protocolos de red (visión SOC)

Un analista de CyberOps debe leer paquetes casi como si fueran líneas de un libro.  
El objetivo del módulo es comprender:

- Estructura del modelo TCP/IP
    
- Protocolos clave que sostienen la comunicación
    
- Cabeceras y campos importantes
    
- Indicadores de ataque al nivel del paquete
    
- Cómo se relacionan estos protocolos con detección en un SOC
    
- Qué herramientas los interpretan (Wireshark, Zeek, Suricata)
    

---

## 1. El modelo TCP/IP (visión operativa real)

Cisco CyberOps usa el modelo TCP/IP (no el OSI tradicional) como base real del tráfico:

1. **Capa de Enlace**  
    Ethernet, WiFi, PPP
    
2. **Capa de Internet**  
    IP, ICMP, ARP
    
3. **Capa de Transporte**  
    TCP, UDP
    
4. **Capa de Aplicación**  
    HTTP, DNS, SMTP, SSH, FTP, etc.
    

El analista SOC necesita entender qué tipo de tráfico debe o no debe existir en cada red.

---

## 2. Protocolo IP (Internet Protocol)

IP es el mensajero. Lleva paquetes de origen a destino.

Campos críticos del encabezado IPv4:

- **Version**
    
- **Header Length**
    
- **TTL (Time To Live)**
    
- **Protocol (6 = TCP, 17 = UDP)**
    
- **Source IP / Destination IP**
    
- **Flags y Fragment Offset**
    

### Señales de ataque a nivel IP:

- TTL muy bajo: puede ser indicador de spoofing.
    
- Fragmentación sospechosa: evasión de IDS.
    
- IPs privadas donde debería haber públicas.
    
- Paquetes con protocolo “raros” (IP 47 GRE en redes no usadas).
    

Zeek y Suricata detectan anomalías en estos campos.

---

## 3. ICMP (Internet Control Message Protocol)

ICMP no es solo “ping”.  
Se usa para diagnóstico, descubrimiento y en ataques.

Tipos verificados:

- **Echo Request / Echo Reply** (8 / 0)
    
- **Destination Unreachable** (3)
    
- **Time Exceeded** (11)
    

### Señales de ataque:

- **Ping sweeps** (mapeo de red)
    
- **ICMP tunneling** (exfiltración encubierta)
    
- **ICMP floods** (DoS)
    

Zeek genera logs icmp.log con detalles de cada mensaje.

---

## 4. ARP (Address Resolution Protocol)

ARP no tiene autenticación.  
Por eso es terreno fértil para ataques locales.

Funciones:

- Convertir IP → MAC
    
- Tabla ARP cacheada en el host
    

### Ataques relevantes:

- **ARP Spoofing / Poisoning**  
    Permite Man-in-the-Middle  
    Detectable por:  
    – múltiples respuestas ARP con MAC distintas  
    – inconsistencias entre ARP y DHCP
    

Cisco CyberOps relaciona este ataque con sniffing y captura de credenciales.

---

## 5. TCP (Transmission Control Protocol)

TCP es la estrella.  
Conexiones fiables, orientadas a sesión.

Cabecera TCP (campos clave):

- **Source Port / Destination Port**
    
- **Sequence Number**
    
- **Acknowledgment Number**
    
- **Flags (SYN, ACK, FIN, RST, PSH)**
    
- **Window Size**
    

### Señales de ataque:

- **SYN Flood**  
    Miles de SYN sin completar handshake.
    
- **Xmas Scan**  
    Flags FIN+PSH+URG encendidos.
    
- **Null Scan**  
    Ningún flag: evasivo.
    
- **RST storms**  
    Interruptores de sesión sospechosos.
    
- **Conexiones a puertos no usados habitualmente**
    

Zeek lo detecta como anomalías y Suricata genera alertas signature-based.

---

## 6. UDP (User Datagram Protocol)

UDP es rápido y sin control. Perfecto para video, VoIP… y ataques.

No hay handshake.  
Campos simples:

- Source Port
    
- Destination Port
    
- Length
    
- Checksum
    

### Señales de ataque:

- Tráfico exagerado a puertos 53, 123, 161
    
- **UDP port scanning** (rápido y silencioso)
    
- **DNS amplification**
    
- **NTP amplification**
    
- **SNMP brute forcing**
    

Zeek y Suricata marcan patrones de flood.

---

## 7. Puertos y servicios típicos (visión SOC)

Los puertos sirven para mapear comportamientos legítimos y detectar anomalías.

Ejemplos importantes:

- 22 SSH
    
- 23 Telnet (no debería existir)
    
- 80/443 HTTP/HTTPS
    
- 53 DNS
    
- 25 SMTP
    
- 110 POP3
    
- 143 IMAP
    
- 445 SMB
    
- 3389 RDP
    

### Señales SOC:

- Tráfico SMB entre hosts que no deben comunicarse
    
- RDP desde redes externas
    
- SSH inbound desde países inusuales
    
- Puertos efímeros conectándose a puertos críticos repetidamente (scan)
    

---

## 8. Cómo ve esto un SOC (Zeek, Suricata, Security Onion)

Un analista CyberOps usa herramientas que convierten tráfico en evidencia:

### Zeek logs (verificables)

- conn.log
    
- dns.log
    
- http.log
    
- ssl.log
    
- files.log
    

### Suricata EVE JSON

- Alerts
    
- Flows
    
- DNS
    
- TLS
    
- HTTP
    
- Fileinfo
    

### Wireshark

Analiza paquetes con precisión quirúrgica:

- Filtros como:
    
    `tcp.flags.syn==1 and tcp.flags.ack==0`
    
    indican SYN flood.
    

---

## 9. Escaneo, descubrimiento y huellas de ataque

Un SOC detecta patrones asociados a herramientas comunes:

### Nmap

- SYN Scan
    
- UDP Scan
    
- Version detection
    
- OS fingerprinting
    

Se delata en:

- TTL consistente
    
- Secuencias de SYN sin conexión
    
- Paquetes ICMP de respuesta
    
- Repetición de puertos en orden creciente
    

### Herramientas ofensivas:

- Masscan
    
- Hping3
    
- Zmap
    

Cada una crea patrones identificables por firmas IDS y análisis de flujo.

---

## 10. Indicadores de tráfico malicioso

El analista SOC debe reconocer:

- Variación anormal del TTL
    
- Conexiones repetidas con SYN sin ACK
    
- Grandes volúmenes de DNS hacia un dominio desconocido
    
- Tráfico hacia IPs de C2 conocidas (Threat Intelligence)
    
- Paquetes fragmentados artificialmente
    
- Uso de puertos no estándar (SSH en 2222, RDP en 5000, etc.)
    
- Tráfico saliente en horarios anómalos
    
- Backdoor: conexiones reverse shell (TCP 4444 o puertos raros)
    

---

## 11. ¿Qué debe saber interpretar un analista CyberOps?

- Handshake TCP completo (SYN → SYN/ACK → ACK)
    
- Reset inesperados
    
- Conexiones half-open
    
- Tráfico HTTPS sin SNI (sospechoso)
    
- DNS queries TXT con payload extendido (exfiltración)
    
- ICMP con tamaños inusuales
    
- UDP sin respuestas repetidas (UDP scan)
    

---

## 12. Relación con MITRE ATT&CK

Técnicas de red asociadas a SOC:

- **T1046 – Network Scanning**
    
- **T1040 – Network Sniffing**
    
- **T1071 – C2 sobre HTTP/HTTPS**
    
- **T1095 – C2 sobre TCP**
    
- **T1571 – Encapsulación**
    
- **T1568 – Exfiltración mediante protocolos alternativos**
    
- **T1020 – Exfiltración a través de canal estándar**