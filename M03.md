# Módulo 3. Sistema Operativo Windows (visión SOC)

Windows es el sistema más atacado del planeta, por volumen de uso y por la riqueza de sus mecanismos internos. En CyberOps, la misión del analista es **interpretar evidencias**, no administrar el sistema. El módulo cubre:

- Arquitectura del sistema
    
- Gestión de usuarios y permisos
    
- Procesos y servicios
    
- Artefactos críticos
    
- Registros (Event Logs)
    
- Sysmon
    
- Técnicas MITRE relacionadas
    
- Señales de ataque
    

Lo desarrollamos punto por punto.

---

## 1. Arquitectura básica de Windows

Cisco y Microsoft centran el estudio en cómo Windows gestiona:

1. **Kernel**  
    El núcleo supervisa memoria, procesos, drivers y comunicación hardware.
    
2. **User Mode**  
    Aquí corren aplicaciones y la mayoría de procesos visibles para el analista.
    
3. **Win32 Subsystem**  
    Donde viven las llamadas API usadas por malware, herramientas de administración y scripts.
    
4. **Registry**  
    Base de datos jerárquica del sistema.  
    Claves críticas:
    
    - HKLM\Software\Microsoft\Windows\CurrentVersion\Run
        
    - HKCU\Software\Microsoft\Windows\CurrentVersion\Run
        
    - HKLM\Security
        
    - HKLM\System
        

---

## 2. Gestión de usuarios, credenciales y permisos

Windows utiliza varios mecanismos para autenticación:

- **SAM (Security Accounts Manager)**  
    Archivo local donde se almacenan los hashes de contraseñas de cuentas locales.  
    Ruta: C:\Windows\System32\config\SAM
    
- **LSASS (Local Security Authority Subsystem Service)**  
    Proceso que maneja logins y tokens.  
    Objetivo típico: Mimikatz (dumping de credenciales).
    
- **NTLM / Kerberos**  
    Protocolos de autenticación.  
    Kerberos es el estándar en entornos AD.
    
- **Token de acceso**  
    Representa permisos.  
    Técnicas de ataque:  
    – Token theft  
    – Token impersonation  
    – Pass-the-Token
    

Verificable mediante MITRE T1134.

---

## 3. Procesos y servicios en Windows

Todo analista SOC debe reconocer procesos legítimos.

Procesos críticos del sistema:

- **System**
    
- **smss.exe**
    
- **csrss.exe**
    
- **wininit.exe**
    
- **services.exe**
    
- **lsass.exe**
    
- **winlogon.exe**
    
- **svchost.exe**
    

Indicadores de alerta:

- Un svchost.exe en ubicación incorrecta.
    
- Un proceso firmado por Microsoft ejecutándose con argumentos extraños.
    
- Un EXE en %TEMP% ejecutándose en bucle.
    

Herramientas verificables para análisis:

- Task Manager
    
- Process Explorer
    
- Process Hacker
    
- Sysmon logs (EID 1: Process Create)
    

---

## 4. Artefactos críticos

Windows deja huellas en múltiples lugares:

1. **Prefetch**  
    Ubicación: C:\Windows\Prefetch  
    Muestra aplicaciones ejecutadas.
    
2. **Shimcache / Amcache**  
    Registro de ejecuciones y binarios instalados.  
    Rutas:
    
    - HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\AppCompatCache
        
    - C:\Windows\AppCompat\Programs\Amcache.hve
        
3. **Event Logs**  
    Sistema centralizado de logging.
    
4. **Resumen de PowerShell**  
    PowerShell ID 4104 (scripts ejecutados),  
    PowerShell ID 4688 (creación de proceso desde PowerShell).
    
5. **Tareas programadas**  
    Persistencia frecuente.  
    Comprobable con:  
    schtasks /query /fo LIST /v
    
6. **Servicios**  
    Persistencia mediante servicios maliciosos.  
    EventID 7045.
    

---

## 5. Event Logs: la mina de oro del SOC

Todos los logs relevantes están en:  
C:\Windows\System32\winevt\Logs\

Windows clasifica eventos en canales:

- **System**
    
- **Security**
    
- **Application**
    
- **PowerShell**
    
- **Microsoft-Windows-Sysmon/Operational** (si Sysmon está instalado)
    

Eventos más importantes para CyberOps (todos verificables en la documentación oficial):

### Autenticación

- **4624**: inicio de sesión exitoso
    
- **4625**: inicio fallido
    
- **4648**: autenticación explícita (runas)
    
- **4672**: privilegios especiales asignados
    
- **4634**: cierre de sesión
    

### Gestión de cuentas

- **4720**: creación de nueva cuenta
    
- **4722**: cuenta habilitada
    
- **4724**: restablecimiento de contraseña
    
- **4726**: eliminación de cuenta
    

### Cambios críticos

- **4732**: adición a grupo privilegiado
    
- **7045**: creación de servicio
    

### File System / Objetos

- **4663**: intento de acceso a un recurso
    
- **4656**: solicitud de handle
    

---

## 6. Sysmon: el visor avanzado del analista SOC

Sysmon (parte de Sysinternals) proporciona telemetría enriquecida.

Eventos clave:

- **Event 1**: creación de proceso
    
- **Event 3**: conexiones de red
    
- **Event 7**: carga de DLL
    
- **Event 8**: creación de threads
    
- **Event 10**: acceso a procesos (técnica para Mimikatz)
    
- **Event 11**: creación de archivos
    
- **Event 12-13**: eventos del registro
    
- **Event 22**: DNS Query
    

Un analista SOC con Sysmon tiene una visión que Windows por defecto no da.

---

## 7. Microsoft Defender y AMSI

Windows Defender y AMSI (Antimalware Scan Interface) son dos capas clave para SOC.

AMSI inspecciona scripts (PowerShell, WSH, JavaScript) para detectar código malicioso.  
Los malwares modernos intentan evadir AMSI mediante:

- Patch en memoria
    
- Cadenas ofuscadas
    
- Invocaciones directas a API
    

Todo está documentado en análisis públicos como los de SpecterOps.

---

## 8. MITRE ATT&CK aplicado a Windows

Tácticas y técnicas habituales:

- **T1059**: ejecución de comandos
    
- **T1047**: WMI para ejecución remota
    
- **T1036**: camuflaje de binarios
    
- **T1547**: persistencia por Run Keys
    
- **T1003**: credential dumping
    
- **T1550**: Pass-The-Token
    
- **T1555**: manipulación de credenciales
    
- **T1027**: ofuscación
    
- **T1053**: Scheduled Tasks
    
- **T1569**: servicios
    

---

## 9. Señales de compromiso típicas en Windows

Si ves cualquiera de estas señales, suena el timbre del SOC:

- Múltiples EventID 4625 seguidos
    
- Conexiones RDP desde IPs inusuales
    
- PowerShell 4104 con código Base64
    
- Creación de servicio 7045 inesperado
    
- Procesos hijos anómalos (cmd.exe lanzado por winword.exe)
    
- Archivo ejecutable en AppData, Roaming o Temp
    
- LSASS accedido por procesos no autorizados
    
- Consumo de CPU en svchost inusual
    
- Regkeys nuevas en Run/RunOnce
    

---

## 10. Herramientas para análisis SOC en Windows

Todas comprobables y ampliamente utilizadas:

- Sysinternals Suite
    
- Autoruns
    
- Process Monitor
    
- Process Explorer
    
- Winlogbeat (para enviar logs al SIEM)
    
- Elastic Agent
    
- Wazuh Agent
    
- Rekall / Volatility (memory forensics)
    
- Zeek y Suricata para ver tráfico desde/ hacia Windows
