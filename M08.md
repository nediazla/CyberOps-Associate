# Módulo 8. Protocolo de Resolución de Direcciones (visión SOC)

Aquí entra en juego la identificación de dispositivos en una red local: cómo se traduce una IP en una MAC (o una dirección IPv6 en una dirección de capa 2), qué tráfico se genera y cómo se ataca este proceso.

Verás tres elementos clave:

1. ARP (Address Resolution Protocol) – IPv4
    
2. NDP (Neighbor Discovery Protocol) – IPv6
    
3. DHCP y DHCP snooping (mitigación en switches)
    

Y sobre todo: **cómo se detectan ataques a estos protocolos en un SOC**.

---

# 1. ARP (Address Resolution Protocol)

## 1.1 ¿Qué es ARP?

ARP resuelve direcciones IPv4 a direcciones MAC.  
Funciona mediante **broadcast** y **cacheado** en cada host.

Sin autenticación.  
Sin cifrado.  
Sin protección contra suplantación.

Por esto es el blanco perfecto para ataques locales.

## 1.2 Funcionamiento normal de ARP

Situación típica:

1. Host A quiere hablar con Host B (misma red).
    
2. A envía:  
    “Who has 192.168.1.20? Tell 192.168.1.10”
    
3. Host B responde con su MAC.
    
4. Ambos guardan la entrada en su ARP cache.
    

Comando verificable:

```
ip neigh 
arp -a
```

## 1.3 Tipos de ARP

- **ARP Request**
    
- **ARP Reply**
    
- **Gratuitous ARP** (autoanuncio)
    
- **Reverse ARP (RARP)** – obsoleto
    

---

# 2. Ataques basados en ARP (100% reales)

### 2.1 ARP Spoofing / Poisoning

El atacante envía respuestas ARP falsas diciendo:

“192.168.1.1 soy yo (MAC del atacante)”.

Resultado:

- Redirección del tráfico del gateway hacia el atacante
    
- Man-in-the-Middle
    
- Sniffing
    
- Modificación de tráfico
    
- Suplantación de identidad
    

Herramientas reales verificables:

- ettercap
    
- arpspoof
    
- bettercap
    
- Cain & Abel (histórico)
    

### 2.2 ARP Flooding

Miles de paquetes ARP para saturar tablas CAM.

### 2.3 MITM + ARP

Combinación clásica:  
arp_poison + sslstrip + dns_spoof.

---

# 3. ¿Cómo detecta un SOC un ataque ARP?

En entornos profesionales, un SOC ve señales como:

### Señales del host:

- ARP cache cambia constantemente
    
- IP del gateway asignada a MAC diferente
    
- Respuestas ARP no solicitadas (gratuitous ARP excesivo)
    

### Señales de red:

- Gran volumen de ARP replies
    
- ARP replies sin request
    
- Cambios de MAC en la red
    
- ARP con TTL bajos o estructura anómala
    
- Tráfico duplicado desde una MAC
    

### Logs en Zeek:

arp.log  
weird.log:

- “bad_arp”
    
- “duplicate_address”
    
- “unexpected_arp_reply”
    

### Suricata EVE:

```
decoder.event: arp_unknown 
decoder.event: arp_malformed
```

Todo comprobable con Zeek y Suricata.

---

# 4. NDP (Neighbor Discovery Protocol) en IPv6

ARP no existe en IPv6.  
IPv6 usa **NDP**, más complejo pero también vulnerable.

NDP combina:

- Neighbor Solicitation (NS)
    
- Neighbor Advertisement (NA)
    
- Router Solicitation
    
- Router Advertisement
    
- Prefix Discovery
    

Ataques reales:

- NDP Spoofing
    
- Rogue Router Advertisement
    
- Fake DHCPv6 server
    
- Neighbor Cache Poisoning
    

Herramientas verificables:

- `thc-ipv6` toolkit
    

Señales SOC:

- Muchos NA sin NS
    
- Router Advertisements desde hosts que no son routers
    
- Prefijos nuevos no autorizados
    

---

# 5. DHCP (Dynamic Host Configuration Protocol)

DHCP asigna:

- IP
    
- Gateway
    
- DNS
    
- Máscara
    
- Otras opciones
    

Es un objetivo crítico porque controla la asignación de red.

## Ataques:

1. **Rogue DHCP server**
    
    - Atacante da direcciones falsas.
        
    - Redirige todo el tráfico al atacante.
        
2. **DHCP Starvation Attack**
    
    - Se consumen todas las IP disponibles.
        
    - Herramientas como Yersinia o dhcpstarv.
        
    - La red se paraliza.
        
3. **MITM basado en DHCP**
    

## Mitigación:

- DHCP Snooping (Cisco)
    
- Port Security
    
- ARP Inspection
    
- Dynamic ARP Inspection
    
- RA Guard (IPv6)
    

En un SOC, estos eventos aparecen en logs del switch y del firewall.

---

# 6. Detección SOC de anomalías DHCP

Señales observables:

- Múltiples solicitudes de DHCP desde la misma MAC
    
- Servidores DHCP desconocidos respondiendo
    
- Clientes obteniendo gateways extraños
    
- Tráfico fraccionado entre redes que no deberían existir
    
- DHCP Offer con parámetros incorrectos
    

Zeek genera:

- dhcp.log
    
- dhcpv6.log
    

Suricata produce alertas de DHCP anómalas:

```
event_type: dhcp 
dhcp.client_mac: "xx:xx:xx:xx" 
dhcp.server_ip: "desconocido"
```

---

# 7. Técnicas MITRE asociadas

- **T1557.002 – ARP Spoofing**
    
- **T1040 – Network Sniffing**
    
- **T1609 – DHCP Spoofing**
    
- **T1498 – Network DoS**
    
- **T1565.002 – Traffic Manipulation**
    

Todo verificable en MITRE ATT&CK.

---

# 8. ¿Qué debe saber interpretar el analista SOC?

Al final de este módulo, un analista debe:

- Leer ARP replies sospechosos en Wireshark
    
- Comparar MAC del gateway real vs falsa
    
- Detectar rogue DHCP servers
    
- Interpretar NDP en IPv6
    
- Identificar flood ARP o DHCP
    
- Analizar Zeek `arp.log`, `dhcp.log` y `weird.log`
    
- Confirmar spoofing mediante:
    
```
ip neigh 
arp -a
```
    
- Detectar MITM antes de que un atacante capture credenciales