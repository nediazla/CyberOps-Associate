# Módulo 6. Protocolos Ethernet e IP (visión SOC)

Este módulo explica la base de la comunicación en red:  
**Ethernet → IP → transporte → aplicación**.  
Nuestro interés como analistas es ver qué alteraciones en esos niveles indican ataque, evasión, manipulación o reconocimiento.

---

# 1. Ethernet (IEEE 802.3)

Ethernet es la tecnología de capa de enlace que transporta tramas entre dispositivos dentro de una red local.  
Es simple, rápida y sin autenticación (detalle clave para ataques internos).

## 1.1 Estructura de una trama Ethernet

Campos principales:

- **Destination MAC**
    
- **Source MAC**
    
- **EtherType** (0x0800 = IPv4, 0x86DD = IPv6, 0x0806 = ARP)
    
- **Payload**
    
- **FCS (Frame Check Sequence)**
    

### Señales de ataque a nivel Ethernet:

- Cambios bruscos de MAC en un host
    
- MAC duplicadas (conflictos)
    
- Tramas con EtherType no esperado
    
- Tramas gigantes (giant frames) o demasiado pequeñas (runts)
    
- FCS incorrecto (intentos de evasión)
    
- Lluvia de broadcast (indicador de escaneo, tormenta o ataque)
    

Un SOC detecta esto mediante:

- SPAN ports
    
- TAPs
    
- Zeek (conn.log + weird.log)
    
- Suricata (decoder events)
    

---

# 2. VLANs (802.1Q)

VLAN no es directamente un protocolo, pero es parte de Ethernet extendido.

Un frame 802.1Q añade:

- **Tag Control Information (TCI)**  
    – VLAN ID (12 bits)  
    – Priority Code Point
    

### Ataques típicos:

- **VLAN hopping**  
    – Trunking no deseado  
    – Double-tagging
    
- **MAC flooding**  
    – Ataca la tabla CAM del switch
    
- **ARP spoofing dentro de VLANs**
    

El SOC detecta esto por:

- Tramas con etiquetas inesperadas
    
- Tráfico entre VLANs que no debería existir
    
- Switch logs indicando CAM overflow
    

Verificable con documentación de Cisco Catalyst.

---

# 3. Protocolo ARP (Address Resolution Protocol)

ARP resuelve IP → MAC.  
No tiene autenticación ni verificación.  
Es el punto más atacado de la red local.

### ARP Operaciones:

- ARP Request
    
- ARP Reply
    
- Gratuitous ARP
    

### Ataques:

- **ARP Spoofing / Poisoning**  
    Manipulación de la tabla ARP para redirigir tráfico del gateway al atacante.
    

### Señales detectables:

- Varias ARP replies por segundo
    
- ARP replies sin haber ARP request
    
- Inconsistencias entre IP/MAC
    
- Cambio repentino del MAC del gateway
    

Zeek produce **arp.log** y alertas “arp_spoof”.

Suricata genera eventos EVE como:

`decoder.event: arp_unknown`

---

# 4. IPv4 (RFC 791)

IP es la capa de Internet.  
Encapsula datos y los envía entre redes.

## 4.1 Estructura de la cabecera IPv4

Campos clave:

- Version
    
- Header Length
    
- DSCP / ECN
    
- Total Length
    
- Identification
    
- Flags (DF, MF)
    
- Fragment Offset
    
- TTL
    
- Protocol (6 = TCP, 17 = UDP)
    
- Header Checksum
    
- Source IP
    
- Destination IP
    

### Comportamientos sospechosos:

- **TTL extremadamente bajo** → spoofing o evasión
    
- **Fragmentación artificial**  
    – evasión de IDS  
    – desorden de fragmentos
    
- **IP de origen privada desde WAN** (spoofing)
    
- **Protocol numbers inusuales**  
    – 47 (GRE) donde no debería existir  
    – 1 (ICMP) saturado en redes que no lo usan
    

En un SOC es fundamental revisar:

- logs de firewall
    
- Netflow/IPFIX
    
- Suricata flow.logs
    

---

# 5. Fragmentación IP

La fragmentación divide un datagrama en partes más pequeñas.

## 5.1 Ataques basados en fragmentación

Verificables en documentación IDS como Snort o Suricata:

- **Tiny Fragment Attack**  
    Divide la cabecera en fragmentos mínimos para evadir firewalls.
    
- **Overlapping Fragments**  
    Intenta engañar reensamblado de IDS.
    
- **Teardrop Attack**  
    Envía fragmentos solapados que dañan ciertos sistemas (históricamente).
    

Zeek detecta “weird events” en weird.log cuando ve fragmentación anómala.

---

# 6. ICMP dentro de IP (RFC 792)

Parte clave para análisis de red.

### Tipos relevantes:

- 0 Echo Reply
    
- 8 Echo Request
    
- 3 Destination Unreachable
    
- 11 Time Exceeded
    

### Actividades maliciosas asociadas:

- Ping sweep
    
- Escaneo ICMP
    
- ICMP tunneling
    
- Exfiltración de datos mediante ICMP payload
    
- Flood ICMP (DoS)
    

Los IDS detectan fácilmente ICMP anómalo por patrones de tamaño y frecuencia.

---

# 7. Relación Ethernet-IP en el SOC

Un analista observa la relación entre capas:

- Si llegan **muchas ARP** → posible MITM
    
- Si el **MAC del gateway cambia** → ataque
    
- Si hay **tramas 802.1Q** donde no hay VLAN → misconfiguración o ataque
    
- Si se ven **fragmentos IP** → evasión o tráfico inusual
    
- Si un host hace **spoofing de IP** → inconsistencia MAC/IP
    

Esta correlación aparece en:

- Zeek conn.log
    
- Zeek weird.log
    
- Suricata eve.json
    
- Switch logs (Cisco Catalyst, Nexus)
    
- Firewalls (ASA, FTD, Palo Alto)
    

---

# 8. Actividades que delatan reconocimiento (Discovery)

Cisco CyberOps se apoya en la fase “Reconnaissance” del MITRE ATT&CK.

### Señales visibles:

- Ping sweeps
    
- ARP sweeps
    
- Enumeración de VLAN
    
- Captura de tráfico (sniffing)
    
- MAC flooding
    
- DHCP starvation
    

Todo esto genera evidencia en logs de capa 2 y capa 3.

---

# 9. MITRE ATT&CK asociado

Técnicas verificadas:

- **T1040** Network Sniffing
    
- **T1046** Network Scanning
    
- **T1498** Network DoS
    
- **T1565.002** Traffic Manipulation
    
- **T1557** Man-in-the-Middle
    
- **T1030** Data Transfer via Protocol
    
- **T1041** Exfiltration Over C2 Channel
    

---

# 10. ¿Qué mira un analista SOC en este módulo?

Ejemplos reales:

- ¿Coincide la MAC del gateway con el valor esperado?
    
- ¿Aparecen ARP replies inesperados?
    
- ¿Hay fragmentación irregular?
    
- ¿Existe tráfico de VLANs no autorizadas?
    
- ¿Se observan EtherTypes raros?
    
- ¿El TTL es irregular entre paquetes del mismo origen?
    

Estas observaciones permiten detectar:

- MITM
    
- Escaneos
    
- Evasión de IDS
    
- Reconocimiento interno
    
- Manipulación de tráfico